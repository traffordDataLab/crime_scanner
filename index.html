<!DOCTYPE html>
<html lang="en-GB">
<head>
  <title>Crime scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta charset="UTF-8"/>
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@traffordDataLab" />
  <meta name="twitter:title" content="Crime Scanner" />
  <meta name="twitter:description" content="Interactively visualise street level crime and anti-social behaviour (ASB) incidents in your area." />
  <meta name="twitter:image" content="https://www.trafforddatalab.io/crime_scanner/crime_scanner_logo.png" />
  <meta name="twitter:image:alt" content="Logo of Crime Scanner application showing a person running away holding a bag whilst being surrounded by scanning waves." />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto"/>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
  <link rel="stylesheet" href="https://www.trafforddatalab.io/css/labBase.css"/>
  <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet//MarkerCluster.TraffordDataLab.css"/>

  <style>
  html, body
  {
    padding: 5px 20px 5em 12px;
  }
  h3
  {
    margin:0px;
    padding: 0px 0px 10px 0px;
  }
  .leaflet-control-attribution a
  {
    color: #fc6721;
  }
  #logo
  {
    display: inline-block;
    float:left ;
    padding-right: 5px;
  }
  #title
  {
    font-size: 25px;
    float:left ;
    display: inline-block;
    color: #757575;
  }
  #map
  {
  width:100%;
  height:300px;
  }
  #tableDiv
  {
  width:100%;
  margin:auto;
  }
  _:-ms-fullscreen, :root #timeLine, #tableDiv{
    height:20vw;
  }
  #region, div[id="Local Authority"], div[id="area type"], #area, div[id="crime categories"]
  {
    float: left;
  }
  #crimeTotal{
    padding: 0px;
    margin: 0px;
  }
  #areaName
  {
    padding-bottom: 20px;
  }
  .clearb{
    clear: both;
    border: 1px;
  }
  .left
  {
    float:left;
    padding-right: 2%;
  }
  .right
  {
    float:right;
    padding-left: 2%;
  }
  .w50
  {
    width:48%;
  }
  .fontS
  {
    font-size: 14px;
  }
  .fontSS
  {
    font-size: 10px;
  }
  .padded
  {
    padding-bottom:1px;
  }
  #downloadCSV, #LSOAbutton
  {
    /*font-size: 12px;*/
    margin: 0px;
  }
  .main
  {
    border-top: 1px solid gray;
    margin-top: 0px;
    padding-top: 10px;
  }
  #focusTitle
  {
    font-size: 17px
  }
  #summarySentence div
  {
    display: inline;
  }
  #summary
  {
    padding-bottom: 20px;
  }
  .sList
  {
    padding-bottom: 6px
  }
  .sList li
  {
    padding-top: 10px;
  }
  #mapTitle
  {
    font-size: 16px;
    padding-top: 10px;
  }
  #progressBar
  {
    width: 0%;
    height: 3px;
    background-color: #fc6721;
    padding: 0;
    margin:0;
  }
  #LSOA4Ward
  {
    padding-bottom: 16px;
  }
  .nonVisible
  {
    opacity: 0;
  }
  #credits
  {
    background-color: #f0f0f0;
    font-size: 12px;
    padding: 5px 20px;
  }
  @media (max-width:800px)
  {
    .w50
    {
      width:100%;
      padding-left: 0px;
      padding-right: 0px;
    }
    #maps
    {
      width:95%;
    }
    #tableDiv
    {
      width:100%;
    }
    .fontS
    {
      font-size: 12px;
    }
    .fontSS
    {
      font-size: 10px;
      padding-bottom: 10px;
    }
    #mapTitle
    {
      font-size: 12px
    }
  }
  @media (min-width:1300px)
  {
    .double
    {
      width: 1240px;
    }
  }
  </style>
</head>
<body>
  <div>
    <div id='logo'><a id="CSlogo" href="http://www.trafforddatalab.io/crime_scanner/index.html"><img src="https://www.trafforddatalab.io/crime_scanner/crime_scanner_logo.png" alt="Crime scanner" height="28" border="0" class="traffordDataLabLogo"/></a></div>
    <div id='title'>Crime Scanner</div>
  </div>
  <div class='clearb'>
    <div class='clearb'>
      <div id='region'></div>
      <div id='Local Authority'></div>
    </div>
    <div class='clearb'>
      <div id='area type'></div>
      <div id='area'></div>
    </div>
  </div>
  <div id="progressBar" class="clearb"></div>
  <div id="mainC" class="main clearb nonVisible">
    <div id='up' class="clearb">
      <div class="left w50">
        <h3 id='areaName'></h3>
        <div class='clearb fontS'>
          <div id='summary' class="clearb">
            <div id='summarySentence'>In&nbsp;<div id='dates'></div>&nbsp;there were <span id="crimeNum"></span> crimes and <span id="asbNum"></span> incidents of anti-social behaviour reported. </div>
          </div>
          <div class="clearb ">
            <div id="focusTitle" class="left padded header">Focus on </div><div id='crime categories'></div>
          </div>
          <div id="focusOn" class="clearb"></div>
          <p>Click on the charts to change the category or month displayed.</p>
          <div id='LSOA4Ward'></div>
          <p class="clearb">Download <span id='downloadCSV' class="labButton" onclick="createCSV()"> CSV </span></p>
        </div>
      </div>
      <div class="right w50">
        <div id= "tableDiv">
          <p id= "tableTitle"></p>
        </div>
      </div>
    </div>
    <div id="down" class="clearb">
      <div class="left w50">
        <div id='timeLine'></div>
      </div>
      <div class="right w50">
        <div id= 'mapTitle' class="clearb fontS"></div>
        <div id= 'map' class="clearb"></div>
        <div class="fontSS">*Locations are only an <a href="https://data.police.uk/about/#location-anonymisation">approximation</a> of where the actual crimes occurred.</div>
      </div>
    </div>
  </div>
  <div id="credits" class='clearb'>
    <p>Crime data from <a href="https://data.police.uk/">data.police.uk</a>, population estimates from the <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates">Office for National Statistics</a>, and digital vector boundaries from <a href="http://geoportal.statistics.gov.uk/">Open Geography Portal</a> are all used under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence v3.0</a>.
      Contains Ordnance Survey data © Crown copyright and database right 2018. Developed by <a href="https://www.trafforddatalab.io" target="_blank">Trafford Data Lab</a> under the <a href="https://www.trafforddatalab.io/LICENSE.txt" target="_blank">MIT</a> License. Need <a href="http://www.trafforddatalab.io/crime_scanner/docs/about.html" target="_blank">help</a> using the Crime Scanner app?</p>
    </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://www.trafforddatalab.io/assets/javascript/labError.js"></script>
    <script src="https://www.trafforddatalab.io/assets/javascript/labAjax.js"></script>
    <script src="https://www.trafforddatalab.io/assets/javascript/labGetQryStrValByKey.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
    <script src="http://www.trafforddatalab.io/assets/d3/timeSeriesClick.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
    <script src="http://www.trafforddatalab.io/assets/d3/horizBarChart.js"></script>
    <script>
    var mainContent = document.getElementById("mainC");
    var formatedDateArray= []
    var lastUpdate= ""
    var responsesArray=[]
    var responses=0
    var partialObj=[]
    var unavailableData=[]
    var monthViz=0
    var categoryViz=0
    var geojsonArray=[]//geojson array
    var arrayCounts=[]
    var categories=[]
    var nameObj={la:"",ward:"",lsoa:""}
    var nameToPrint=""
    var areaName=""
    var areaCode=""
    var counterArray=[]
    var parseTime = d3.timeParse("%Y-%m");
    var formatTimeB = d3.timeFormat("%B %Y");
    var formatTimeC = d3.timeFormat("%b %Y");
    var numFormat = d3.format(",");
    var stringCSV = ""
    var fail=false
    var population=0
    var regionToLAD=[]
    var LADToWD=[]

    if (location.protocol == 'https:')
    location.href = location.href.replace(/^https:/, 'http:')

    window.onpopstate = function(event) {
      window.location.reload(true)
    };

    getLastUpdateDate()
    getCategories()//call readURLData()
    loadAreas ("{}")

    var regionArray=[{attributes:{RGN17CD: "E12000007", RGN17NM: "London"}},{attributes:{RGN17CD: "E12000002", RGN17NM: "North West"}},{attributes:{RGN17CD: "E12000003", RGN17NM: "Yorkshire and The Humber"}},{attributes:{RGN17CD: "E12000001", RGN17NM: "North East"}},{attributes:{RGN17CD: "E12000005", RGN17NM: "West Midlands"}},{attributes:{RGN17CD: "E12000004", RGN17NM: "East Midlands"}},{attributes:{RGN17CD: "E12000009", RGN17NM: "South West"}},{attributes:{RGN17CD: "E12000006", RGN17NM: "East of England"}},{attributes:{RGN17CD: "E12000008", RGN17NM: "South East"}}]
    popSelect(regionArray,"region","loadLocalAuthorityList","RGN")

    var dateNow = new Date();
    var leafletMap = L.map('map')
    tiles=L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://cartodb.com/attributions">CartoDB</a> Contains National Statistics &amp; OS data <a href="https://www.ons.gov.uk/methodology/geography/licences">&copy; Crown copyright and database right ' + dateNow.getFullYear() + '</a>',
    }).addTo(leafletMap);
    boundaryGroup = L.layerGroup().addTo(leafletMap);
    clusters = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    });

    function getLastUpdateDate(){
      //get the latest date
      var dateLastUpdated = "https://data.police.uk/api/crime-last-updated"
      var lastUpdate =""
      labAjax(dateLastUpdated,generateDates,{data:dateLastUpdated, method: 'POST', header: [{ header: 'Accept', value: 'application/sparql-results+json' }, { header: 'Content-Type', value: 'application/x-www-form-urlencoded'}]})
    }

    function generateDates(lastDateObj){
      lastUpdate= lastDateObj.date.slice(0,-3)
      monthViz=0
      formatedDateArray= []
      currentDateKey = ""
      nextDateKey= ""
      yeartoSend=lastUpdate.slice(0,-3)
      monthtoSend=lastUpdate.slice(5)

      for (var i = 0;i<36;i++){
        currentDateKey = yeartoSend + "-" + monthtoSend
        formatedDateArray.push(currentDateKey)
        if(monthtoSend=="01"){
          yeartoSend = (parseInt(yeartoSend)-1).toString()
          monthtoSend="12"
        } else {
          monthtoSend=("0" + (parseInt(monthtoSend)-1)).slice(-2)
        }
      }
      popSelectDates(formatedDateArray,"dates","updateDates");
      document.getElementById('selectDate').disabled=true;
    }

    function loadLocalAuthorityList(LAkey){
      if(document.getElementById('loadAreas'))document.getElementById('loadAreas').disabled=true;

      if(LAkey=="{}"){
        loadAreas ("{}")
        document.getElementById('area').innerHTML = "";
        document.getElementById('Local Authority').innerHTML = "";
      }else{
        document.getElementById('area').innerHTML = "";
        document.getElementById('areaType').disabled=true;
        var LAkey=JSON.parse(LAkey.replace(/£/g, '"'));
        var area_code = LAkey["area_code"];
        var area_name = LAkey["area_name"];
        d3.json("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/LAD17_RGN17_EN_LU/FeatureServer/0/query?outFields=*&where=rgn17cd=%27"+ area_code +"%27&f=json", function(error, w) {
          popSelect(w.features,"Local Authority","loadAreas","LAD")
          document.getElementById('loadAreas').disabled=false;
        })
      }
    }

    function loadAreas (LAkey) {

      if(LAkey=="{}"){
        document.getElementById('area').innerHTML = "";

        var laSelect = '<select id="areaType" name="frmTypes" onChange="loadAreaList(this.value)" class="datasetSelect"><option value="{}">Select an area type</option>';
        laSelect += '</select>';
        var divf = document.createElement('div');
        divf.innerHTML = laSelect;
        document.getElementById("area type").innerHTML = "";
        document.getElementById("area type").appendChild(divf);
        document.getElementById('areaType').disabled=true;
      }else{
        document.getElementById('area').innerHTML = "";
        var LAkey=JSON.parse(LAkey.replace(/£/g, '"'));
        var area_code = LAkey["area_code"];
        var area_name = LAkey["area_name"];
        var laSelect = '<select id="areaType" name="frmTypes" onChange="loadAreaList(this.value)" class="datasetSelect"><option value="{}">Select an area type</option>';
        laSelect += '<option value="{£area_name£:£' + area_name + '£,£area_code£:£' + area_code + '£,£area_type£:£Local Authority£}"';
        laSelect += '>Local Authority</option>';
        laSelect += '<option value="{£area_name£:£' + area_name + '£,£area_code£:£' + area_code + '£,£area_type£:£ward£}"';
        laSelect += '>Ward</option>';
        laSelect += '</select>';
        var divf = document.createElement('div');
        divf.innerHTML = laSelect;
        document.getElementById("area type").innerHTML = "";
        document.getElementById("area type").appendChild(divf);

        nameObj["la"]=area_name;
        nameObj["ward"]="";
        nameObj["lsoa"]="";
      }
    }

    function loadAreaList (LAkey){

      document.getElementById("area").innerHTML=""
      var LAkey=JSON.parse(LAkey.replace(/£/g, '"'));
      var area_code = LAkey["area_code"];
      var area_name = LAkey["area_name"];
      var area_type = LAkey["area_type"];

      if(area_type == "Local Authority"){
        key= '{"area_name":"' + area_name + '", "area_code":"' + area_code + '"}';
        getBoundaries(key)
      } else if (area_type == "ward"){

        d3.json("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/WD17_LAD17_UK_LU/FeatureServer/0/query?outFields=*&where=lad17cd=%27"+ area_code +"%27&f=json", function(error, w) {
          popSelect(w.features,"area","getBoundaries","WD")
          document.getElementById('getBoundaries').disabled=false;
        })
      }
    }

    function getBoundaries(key) {
      var key=JSON.parse(key.replace(/£/g, '"'));
      var area_code = key["area_code"];
      var area_name = key["area_name"];
      var area_type = key["area_type"];
      //var areaTypeKey = ""
      if (/^E01/.test(area_code)){
        nameObj["lsoa"]=area_name;
        //areaTypeKey = "lsoa11cd"
        var geoserviceURL="https://ons-inspire.esriuk.com/arcgis/rest/services/Census_Boundaries/Lower_Super_Output_Areas_December_2011_Boundaries/MapServer/2/query?where=lsoa11cd=%27"+ area_code +"%27&outFields=*&outSR=4326&f=geojson"
      }else if (/^E05/.test(area_code)){
        nameObj["ward"]=area_name;
        nameObj["lsoa"]="";
        var geoserviceURL="https://ons-inspire.esriuk.com/arcgis/rest/services/Administrative_Boundaries/Wards_December_2017_Boundaries/MapServer/2/query?where=wd17cd=%27"+ area_code +"%27&outFields=*&outSR=4326&f=geojson"
        //areaTypeKey = "wd11cd"
      }else{
        nameObj["la"]=area_name;
        nameObj["ward"]="";
        nameObj["lsoa"]="";
        var geoserviceURL="https://ons-inspire.esriuk.com/arcgis/rest/services/Administrative_Boundaries/Local_Authority_Districts_December_2017_Boundaries/MapServer/3/query?where=lad17cd=%27"+ area_code +"%27&outFields=*&outSR=4326&f=geojson"
      }

      if (nameObj["la"]!="" && nameObj["ward"]!="" && nameObj["lsoa"]!=""){
        nameToPrint=nameObj["lsoa"]+", "+nameObj["la"]
      }
      if (nameObj["la"]!="" && nameObj["ward"]!="" && nameObj["lsoa"]==""){
        nameToPrint=nameObj["ward"]+", "+nameObj["la"]
      }
      if (nameObj["la"]!="" && nameObj["ward"]==""){
        nameToPrint=nameObj["la"]
      }
      areaName=area_name
      areaCode=area_code;
      //processJson(geoserviceURL)
      d3.json(geoserviceURL, function(error, geoData) {prepCoordsForDP(geoData.features[0])})
      var pBar=document.getElementById("progressBar")
      pBar.style.width = '3%';
    }

    function prepCoordsForDP(simpleGeoJson){
      //boundaries for Police API,
      var coordinatesArray = simpleGeoJson.geometry.coordinates;
      var coordinatesStringArray = [];

      if (coordinatesArray.length>1){
        for (i=0;i<coordinatesArray.length;i++){
          var arrayLength = coordinatesArray[i][0].length
          var coordinatesString = ""

          for (var j = 0; j < arrayLength-1; j++) {
            coordinatesString += coordinatesArray[i][0][j][1].toFixed(6) + ","
            if (j==arrayLength-2){
              coordinatesString += coordinatesArray[i][0][j][0].toFixed(6)
            } else {
              coordinatesString += coordinatesArray[i][0][j][0].toFixed(6) + ":"
            }
          }
          coordinatesStringArray.push(coordinatesString)
        }
      }else{

        for (i=0;i<coordinatesArray.length;i++){
          var arrayLength = coordinatesArray[i].length
          var coordinatesString = ""

          for (var j = 0; j < arrayLength-1; j++) {
            coordinatesString += coordinatesArray[i][j][1].toFixed(6) + ","
            if (j==arrayLength-2){
              coordinatesString += coordinatesArray[i][j][0].toFixed(6)
            } else {
              coordinatesString += coordinatesArray[i][j][0].toFixed(6) + ":"
            }
          }
          coordinatesStringArray.push(coordinatesString)
        }
      }

      boundaryGroup.clearLayers();
      clusters.clearLayers();
      boundary = L.geoJSON(simpleGeoJson,{style:{"color":"grey"}})
      .addTo(boundaryGroup);
      leafletMap.fitBounds(boundary.getBounds()); // adjust the zoom to fit the boundary to the screen size

      var polyCount=coordinatesStringArray.length
      responsesArray=[]
      responses=0
      partialObj=[]
      for(i=0;i<polyCount;i++){
        responsesArray.push([])
        sendPoliceDataRequest(coordinatesStringArray[i],i,polyCount);
      }
    }

    function sendPoliceDataRequest(coordinatesString,polyIndex,polyCount){

      urlDP = "https://data.police.uk/api/crimes-street/"+categories[0].url+"?"
      d3.select("#timeLine").select("svg").attr("filter", "url(#desaturate)").style("pointer-events","none");
      d3.select("#tableDiv").select("svg").attr("filter", "url(#desaturate)").style("pointer-events","none");;
      for (var i = 0; i < formatedDateArray.length; i++) {
        sleep(1000);
        data = "poly="+encodeURIComponent(coordinatesString)+"&date="+encodeURIComponent(formatedDateArray[i]);
        partialObj[i]=[]
        scheduleDataRequest(data,i,polyIndex,polyCount);
      }
    }

    function scheduleDataRequest(data,dateIndex,polyIndex,polyCount){
      var elemSelect=document.getElementsByClassName("datasetSelect")
      Array.prototype.forEach.call(elemSelect,function(element) {
        element.disabled=true;
      });

      document.getElementById("downloadCSV").style.pointerEvents="none";

      if (/^E08000003/.test(areaCode) || /^E08000012/.test(areaCode)){
        partialObj[polyIndex][dateIndex]={index:dateIndex,crimeObj:[],count:0}
        for (var j = 1; j<categories.length; j++){
          urlDPcat = "https://data.police.uk/api/crimes-street/"+categories[j].url+"?";
          reScheduleDataRequest(data,urlDPcat,dateIndex,polyIndex,polyCount)
        }
      }else{
        labAjax(urlDP,function(d){
          responsesArray[polyIndex].push([d,dateIndex]);

          if (responsesArray[polyIndex].length==formatedDateArray.length){responses=responses+1}
          if (fail==false)statusBar()
          if (responses==polyCount){
            if(fail==false){
              produceGeoJson(responsesArray)
            }else{
              alert("Incomplete or missing response from the server, please try again. If the problem persists try later.");
              fail==false;
              var elemSelect=document.getElementsByClassName("datasetSelect")
              Array.prototype.forEach.call(elemSelect,function(element) {
                element.disabled=false;
              });
              document.getElementById("downloadCSV").style.pointerEvents="auto"
            }
          }
        },{ data:data, method: 'POST', header: [{ header: 'Accept', value: 'application/sparql-results+json' }, { header: 'Content-Type', value: 'application/x-www-form-urlencoded'}], unsuccessfulRequest: testForUnsuccesful})
      }
    }

    function reScheduleDataRequest(data,url,dateIndex,polyIndex,polyCount){
      labAjax(url,function(d){
        if (fail==false){
          partialObj[polyIndex][dateIndex].count=partialObj[polyIndex][dateIndex].count+1;
          if (d === null){
            unavailableData.push({month:i,category:j})
          }else{
            partialObj[polyIndex][dateIndex].crimeObj=partialObj[polyIndex][dateIndex].crimeObj.concat(d);
          }
          if (partialObj[polyIndex][dateIndex].count==categories.length-1){
            responsesArray[polyIndex].push([partialObj[polyIndex][dateIndex].crimeObj,dateIndex])

            if (responsesArray[polyIndex].length==formatedDateArray.length){responses=responses+1}
            if(fail==false)statusBar()
            if (responses==polyCount){
              if(fail==false){
                produceGeoJson(responsesArray)
              }else{
                alert("Incomplete or missing response from the server, please try again. If the problem persists try later.");
                fail==false;
                var elemSelect=document.getElementsByClassName("datasetSelect")
                Array.prototype.forEach.call(elemSelect,function(element) {
                  element.disabled=false;
                })
                document.getElementById("downloadCSV").style.pointerEvents="auto"
              }
            }
          }
        }
      },{ data:data, method: 'POST', header: [{ header: 'Accept', value: 'application/sparql-results+json' }, { header: 'Content-Type', value: 'application/x-www-form-urlencoded'}], unsuccessfulRequest: testForUnsuccesful})
    }

    function testForUnsuccesful(request){
      fail=true
    }

    function produceGeoJson(arrApiData){
      for (i=0;i<arrApiData.length;i++){
        arrApiData[i].sort(function(a, b) {
          return a[1] - b[1];
        });
      }
      for (i=0;i<formatedDateArray.length;i++){
        for (j=1;j<arrApiData.length;j++){
          arrApiData[0][i][0]=arrApiData[0][i][0].concat(arrApiData[j][i][0])
        }
      }
      var arrApiDataMP=arrApiData[0]

      updateURL()
      monthViz=0
      categoryViz=0
      var element = document.getElementById("selectDate");
      element.value=monthViz
      var element = document.getElementById("selectCategory");
      element.value=categoryViz
      geojsonArray=[]//geojson array
      arrayCounts=[]

      var counterObj={}
      stringCSV="area_code,area_name,date,category,count"
      for (var c = 0; c <categories.length; c++) {
        counterObj[categories[c].name] = []
      }

      //iterating over each month
      for (var i = 0; i < arrApiDataMP.length; i++) { //i is the date index
        var geoJsonMonth = []
        var countsMonth = []

        for (var c = 0; c <categories.length; c++) {
          counterObj[categories[c].name].push({serie: categories[c].name, date: formatedDateArray[i], value: 0})
        }
        //iterate over each crime
        for (var j = 0; j < arrApiDataMP[i][0].length; j++) { //j is the crime number
          var  crimeObj = {
            "type": "Feature",
            "properties": {"category": "", "street":arrApiDataMP[i][0][j].location.street.name},
            "geometry": {
              "type": "Point",
              "coordinates": [parseFloat(arrApiDataMP[i][0][j].location.longitude),parseFloat(arrApiDataMP[i][0][j].location.latitude)]
            }
          }

          for (var c = 0; c<categories.length; c++){
            if (categories[c].url==arrApiDataMP[i][0][j].category){
              if (categories[c].name=="Anti-social behaviour"){
                counterObj[categories[c].name][i].value=counterObj[categories[c].name][i].value+1
                crimeObj.properties.category="Anti-social behaviour";
              } else {
                counterObj[categories[c].name][i].value=counterObj[categories[c].name][i].value+1
                counterObj[categories[0].name][i].value=counterObj[categories[0].name][i].value+1
                crimeObj.properties.category=categories[c].name;
              }
              break;
            }
          }
          geoJsonMonth.push(crimeObj)
        }
        for (var c = 0; c<categories.length; c++){
          stringCSV+="\n"+areaCode+","+areaName+","+formatedDateArray[i]+","+categories[c].name+","+counterObj[categories[c].name][i].value+""
        }
        geojsonArray.push(geoJsonMonth)
      }

      document.getElementById("progressBar").style.width = '0%';

      arrayCounts=[counterObj]
      produceMap();
      produceTimeline();
      callHorizontalBarChart();
      getPopulation()
      //produceSummaryStatistics();
      mainContent.classList.remove("nonVisible");

      var elemSelect=document.getElementsByClassName("datasetSelect")
      Array.prototype.forEach.call(elemSelect,function(element) {
        element.disabled=false;
      });
      document.getElementById("downloadCSV").style.pointerEvents="auto"

    }

    function updateCategory(category){
      categoryViz=category;
      produceMap()
      produceTimeline()
      produceSummaryStatistics()
      callHorizontalBarChart()
    }

    function updateDates(dateObj){
      monthViz=parseInt(dateObj);
      produceMap()
      produceTimeline()
      callHorizontalBarChart()
      produceSummaryStatistics()
    }

    function updateURL(){
      //var keyName=nameToPrint
      if (/E05/.test(areaCode) ){
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?code='+areaCode+'&name='+ encodeURIComponent(areaName) + '&within=' + encodeURIComponent(nameObj['la']);
      }else if (!/E01/.test(areaCode) ){
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?code='+areaCode+'&name='+ encodeURIComponent(areaName);
      }

      window.history.pushState({path:newurl},'',newurl);
    }

    function produceMap(){
      //leaflet clustered map

      document.getElementById('areaName').innerHTML=nameToPrint
      document.getElementById('mapTitle').innerHTML="Reports of "+ categories[categoryViz].name + ", "+formatTimeC(parseTime(formatedDateArray[monthViz]))
      clusters.clearLayers();
      //show recent month
      var geojsonMarkerOptions = {
        color: 'white',
        opacity: 0.8,
        weight: 1,
        fillColor: "#fc6721",
        fillOpacity: 0.8,
        radius: 5
      };

      L.geoJson(geojsonArray[monthViz], {filter: filterCategory, pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, geojsonMarkerOptions).bindPopup(feature.properties.street);;
      }}).addTo(clusters)//.addTo(leafletMap);
      leafletMap.addLayer(clusters);

      function filterCategory(feature) {
        if (feature.properties.category === categories[categoryViz].name) return true
        else if (categories[categoryViz].name === "All crime"){
          if (!(feature.properties.category === "Anti-social behaviour")) return true
        }
      }
    }

    function produceTimeline(){

      var formatTime = "%Y-%m";
      var plotParams={data:[arrayCounts[0][categories[categoryViz].name]],
        formatTime:formatTime,
        container:"#timeLine",
        palette:["#fc6721"],
        title:"Number of incidents over the past three years, "+ areaName,
        ytitle:"Count",
        clickFunction:clickDate,
        ytickFormat:"integer",
        markClick:true,
        indexToMark:monthViz,
        height: 400,
        weight:800
      }
      document.getElementById('timeLine').innerHTML = "";
      var svg=timeSeries(plotParams)

      var filter = d3.select('#timeLine').select('svg').append("defs")
      .append("filter")
      .attr('id','desaturate')
      .append('feColorMatrix')
      .attr('type','matrix')
      .attr('values',"0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 1 0 ");
    }

    function popSelect(data,container,onChangeFun,preffix){

      data.sort(function(a, b){
        if(a.attributes[preffix+"17NM"] < b.attributes[preffix+"17NM"]) { return -1; }
        if(a.attributes[preffix+"17NM"] > b.attributes[preffix+"17NM"]) { return 1; }
        return 0;
      })
      var laSelect = '<select id="'+ onChangeFun + '" name="'+ onChangeFun + '" onChange="' + onChangeFun + '(this.value)" class="datasetSelect"><option value="{}">Select ' + container + '</option>';

      for (var i = 0; i < data.length; i++) {
        laSelect += '<option value="{£area_name£:£' + data[i].attributes[preffix+"17NM"] + '£,£area_code£:£' + data[i].attributes[preffix+"17CD"] + '£}"';
        laSelect += '>' + data[i].attributes[preffix+"17NM"] + '</option>';
      }
      laSelect += '</select>';
      var divf = document.createElement('div');
      divf.innerHTML = laSelect;
      document.getElementById(container).innerHTML = "";
      document.getElementById(container).appendChild(divf);
      document.getElementById(onChangeFun).disabled=true;
    }

    function popSelectDates(dataArray,container,onChangeFun){
      var selectDate = '<select id="selectDate" name="selectDate" onChange="' + onChangeFun + '(this.value)" class="datasetSelect">'
      for (var i = 0; i < dataArray.length; i++) {
        selectDate += '<option value="'+i+'"';
        selectDate += '>' + formatTimeC(parseTime(formatedDateArray[i])) + '</option>';
      }
      selectDate += '</select>';
      var divf = document.createElement('div');
      divf.innerHTML = selectDate;
      document.getElementById(container).innerHTML = "";
      document.getElementById(container).appendChild(divf);
    }

    function getCategories(){
      var dataCategoriesDate="https://data.police.uk/api/crime-categories?date="+lastUpdate
      labAjax(dataCategoriesDate,function(d){

        categories=d;
        categories.sort(function(a, b) {
          if(a["name"] < b["name"]) { return -1; }
          if(a["name"] > b["name"]) { return 1; }
          return 0;
        });
        readURLData();
        popSelectCategories()
        document.getElementById('selectCategory').disabled=true
      },{data:dataCategoriesDate, method: 'POST', header: [{ header: 'Accept', value: 'application/sparql-results+json' }, { header: 'Content-Type', value: 'application/x-www-form-urlencoded'}]})
    }

    function popSelectCategories(){
      var selectDate = '<select id="selectCategory" name="selectCategory" onChange="updateCategory(this.value)" class="datasetSelect">'
      for (var i = 0; i < categories.length; i++) {
        selectDate += '<option value="'+i+'"';
        selectDate += '>' + categories[i]["name"] + '</option>';
      }
      selectDate += '</select>';
      var divf = document.createElement('div');
      divf.innerHTML = selectDate;
      document.getElementById("crime categories").innerHTML = "";
      document.getElementById("crime categories").appendChild(divf);
    }

    function callHorizontalBarChart(){

      document.getElementById('tableDiv').innerHTML = "";
      var arrayBarchart = []
      for (var i = 2; i < categories.length; i++) {
        arrayBarchart.push({name:categories[i]["name"],value:arrayCounts[0][categories[i]["name"]][monthViz]["value"]})
      }
      var barChartParams={data:arrayBarchart,
        container:"#tableDiv",
        barColour:"white",
        markClick:true,
        title:"Counts per crime category, "+ areaName + ", "+formatTimeC(parseTime(formatedDateArray[monthViz])),
        clickFunction:clickCategory,
        indexToMark:categoryViz
      }

      var svg=horizontalBarChart(barChartParams)

      var filter = d3.select('#tableDiv').select('svg').append("defs")
      .append("filter")
      .attr('id','desaturate')
      .append('feColorMatrix')
      .attr('type','matrix')
      .attr('values',"0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 1 0 ");
    }

    function produceSummaryStatistics(){

      //document.getElementById("summarySentence").innerHTML='There were ' + numFormat(arrayCounts[0][categories[0]["name"]][monthViz]["value"]) + ' crimes and ' + numFormat(arrayCounts[0][categories[1]["name"]][monthViz]["value"]) + ' incidents of anti-social behaviour reported during';
      document.getElementById("crimeNum").innerHTML=numFormat(arrayCounts[0][categories[0]["name"]][monthViz]["value"])
      document.getElementById("asbNum").innerHTML=numFormat(arrayCounts[0][categories[1]["name"]][monthViz]["value"])
      var thisMonth=arrayCounts[0][categories[categoryViz].name][monthViz].value
      var prevMonth=0
      var rateString=""
      if (population>0 && thisMonth>0){
        rateString="(" + (thisMonth/population*1000).toFixed(1) + " per 1,000 residents)"
      }
      var noun="offences"
      if (categoryViz==1){
        noun="incidents"
      }
      var focusOnP1="<li>"+ numFormat(thisMonth) +" "+noun+" "+rateString+" were reported during "+formatTimeB(parseTime(formatedDateArray[monthViz]))+".</li>"
      //last available month with same month last year/
      var focusOnP2=""
      if (!(categoryViz==0 || categoryViz==1)){
        var perOfTotal=arrayCounts[0][categories[categoryViz].name][monthViz].value/arrayCounts[0][categories[0].name][monthViz].value*100

        if (perOfTotal>0){
          focusOnP2="<li>These " + noun + " represent "+ perOfTotal.toFixed(1)+"% of all reported crime.</li>"
        }

      }
      var focusOnP3=""
      if(monthViz<24){
        focusOnP3+="<li>"
        prevMonth=arrayCounts[0][categories[categoryViz].name][monthViz+12].value
        var monthChange=(thisMonth-prevMonth)/prevMonth*100
        if(monthChange == Number.POSITIVE_INFINITY || monthChange == Number.NEGATIVE_INFINITY || monthChange == NaN){
          focusOnP3+= "There were " + numFormat(prevMonth) + " " + noun + " reported the same month last year"
        } else if (monthChange>0){
          focusOnP3+= "There were " + Math.abs(monthChange.toFixed(1)) + "% more "+noun+" than the same month last year (n = "+ numFormat(prevMonth) +")"
        } else if (monthChange<0){
          focusOnP3+= "There were " + Math.abs(monthChange.toFixed(1)) + "% fewer "+noun+" than the same month last year (n = "+ numFormat(prevMonth) +")"
        } else if (monthChange==0){
          focusOnP3+= "There were the same number of "+ noun +" as the same month last year (n = "+ numFormat(prevMonth) +")"
        } else {
          focusOnP3+= "There were " + numFormat(prevMonth) + " " + noun + " reported the same month last year"
        }

        if(monthViz<12){
          var lastYear=0
          var prevYear=0
          for(i=monthViz;i<monthViz+12;i++){
            lastYear+=arrayCounts[0][categories[categoryViz].name][i].value
            prevYear+=arrayCounts[0][categories[categoryViz].name][i+12].value
          }
          var yearChange=(lastYear-prevYear)/prevYear*100

          if(yearChange == Number.POSITIVE_INFINITY || yearChange == Number.NEGATIVE_INFINITY || yearChange == NaN){
            focusOnP3+= ", "+ numFormat(lastYear) + " over the past 12 months and " + numFormat(prevYear) + " over the previous 12 months"
          } else if (yearChange>0){
            focusOnP3+= ", and " + Math.abs(yearChange.toFixed(1)) + "% more over the past 12 months (n = "+ numFormat(lastYear) +") compared with the preceding 12 months (n = "+ numFormat(prevYear) +")"
          } else if (yearChange<0){
            focusOnP3+= ", and " + Math.abs(yearChange.toFixed(1)) + "% fewer over the past 12 months (n = "+ numFormat(lastYear) +") compared with the preceding 12 months (n = "+ numFormat(prevYear) +")"
          } else if (yearChange==0){
            focusOnP3+= ", and the same over the past 12 months (n = "+ numFormat(lastYear) +") compared with the preceding 12 months (n = "+ numFormat(prevYear) +")"
          } else {
            focusOnP3+= ", "+ numFormat(lastYear) + " over the past 12 months and " + numFormat(prevYear) + " over the previous 12 months"
          }
        }
        focusOnP3+=".</li>"
      }

      document.getElementById("focusOn").innerHTML="<ul class='sList'>"+focusOnP1+focusOnP2+focusOnP3+"<ul>"

    }

    function clickDate(e,d){
      for (var i=0;i < formatedDateArray.length;i++){
        if (formatedDateArray[i]==d.date){
          monthViz=i;
          produceMap()
          callHorizontalBarChart()
          produceSummaryStatistics()
          var element = document.getElementById("selectDate");
          element.value=monthViz
          break;
        }
      }
    }

    function clickCategory(e,d){
      for (var i = 0; i < categories.length; i++){
        if (categories[i].name==d.name){
          categoryViz = i
          produceMap()
          produceTimeline()
          produceSummaryStatistics()
          var element = document.getElementById("selectCategory");
          element.value = categoryViz
        }
      }
    }

    function postQuery(query, url, callback){
      query="query="+encodeURIComponent(query)
      labAjax(url,callback,{ data:query, method: 'POST', header: [{ header: 'Accept', value: 'application/sparql-results+json' }, { header: 'Content-Type', value: 'application/x-www-form-urlencoded'}] });
    }

    function createCSV(){

      var download = function(content, fileName, mimeType) {
        var a = document.createElement('a');
        mimeType = mimeType || 'application/octet-stream';

        if (navigator.msSaveBlob) { // IE10
          navigator.msSaveBlob(new Blob([content], {
            type: mimeType
          }), fileName);
        } else if (URL && 'download' in a) { //html5 A[download]
          a.href = URL.createObjectURL(new Blob([content], {
            type: mimeType
          }));
          a.setAttribute('download', fileName);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } else {
          location.href = 'data:application/octet-stream,' + encodeURIComponent(content); // only this mime type is supported
        }
      }
      download(stringCSV, 'Crime-Data.csv', 'text/csv;encoding:utf-8');
    }

    function readURLData(){
      var code=labGetQryStrValByKey("code")
      var name=labGetQryStrValByKey("name")
      var within = (labGetQryStrValByKey("within")) ? labGetQryStrValByKey("within"):"";
      nameToPrint=name;
      nameObj["la"]=within

      if (/^E0/.test(code)){
        getBoundaries('{"area_name":"' + name + '", "area_code":"' + code + '"}')
      }else{
        //code=E05000825&name=Clifford&within=Trafford
        nameToPrint="Clifford";
        nameObj["la"]="Trafford";
        getBoundaries('{"area_name":"Clifford", "area_code":"E05000825"}')
      }
    }

    function statusBar(){
      var monthResp=0
      for (var i = 0; i < responsesArray.length; i++){
        monthResp=monthResp+responsesArray[i].length
      }
      var width=monthResp*97/(36*responsesArray.length);
      var pBar=document.getElementById("progressBar")
      pBar.style.width = (width+3) + '%';
    }

    function LSOAsLink(){

      d3.json("https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/LSOA11_WD17_EW_LU/FeatureServer/0/query?outFields=*&where=wd17cd=%27"+ areaCode +"%27&f=json", function(error, lookUp) {

        if (lookUp.features.length>0){
          document.getElementById("LSOA4Ward").innerHTML="<div class='left'>Looking for <a onclick='showLSOASelect()'>LSOAs</a>?</div><div id='LSOA' class='left'></div>"

          var LSOASelect = '<select id="LSOASelect" name="LSOASelect" onChange="getBoundaries(this.value)" class="datasetSelect"><option value="{}">Select LSOA</option>';

          for (var i = 0; i < lookUp.features.length; i++) {
            LSOASelect += '<option value="{£area_name£:£' + lookUp.features[i].attributes["LSOA11CD"] + '£,£area_code£:£' + lookUp.features[i].attributes["LSOA11CD"] + '£,£area_type£:£LSOA£}"';
            LSOASelect += '>' + lookUp.features[i].attributes["LSOA11CD"] + '</option>';
          }
          LSOASelect += '</select>';
          var divf = document.createElement('div');
          divf.innerHTML = LSOASelect;
          document.getElementById("LSOA").innerHTML = "";
          document.getElementById("LSOA").appendChild(divf);
          var elem=document.getElementById("LSOA");
          elem.classList.add("nonVisible");
        }else{
          document.getElementById("LSOA4Ward").innerHTML=""
        }
      })
    }

    function showLSOASelect(){
      var LSOADiv = document.getElementById("LSOA");
      LSOADiv.classList.remove("nonVisible");
    }

    function LSOApopup(){

      var LSOASelect = '<select id="LSOASelect" name="LSOASelect" onChange="getBoundaries(this.value)" class="datasetSelect"><option value="{}">Select LSOA</option>';

      for (var i = 0; i < lookUp[areaCode].length; i++) {
        LSOASelect += '<option value="{£area_name£:£' + lookUp[areaCode][i]["lsoa11cd"] + '£,£area_code£:£' + lookUp[areaCode][i]["lsoa11cd"] + '£,£area_type£:£LSOA£}"';
        LSOASelect += '>' + lookUp[areaCode][i]["lsoa11cd"] + '</option>';
      }
      LSOASelect += '</select>';
      var divf = document.createElement('div');
      divf.innerHTML = LSOASelect;
      document.getElementById("LSOA").innerHTML = "";
      document.getElementById("LSOA").appendChild(divf);
    }

    function getPopulation(){
      d3.json("http://www.trafforddatalab.io/crime_scanner/population.json", function(error, populationArray) {

        if(populationArray[areaCode]){
          population=populationArray[areaCode]["population"]
        }else{
          population=0
        }
        produceSummaryStatistics()
      })
      if (/^E05/.test(areaCode)) {
        LSOAsLink()
      } else if (!/^E01/.test(areaCode)) {
        document.getElementById("LSOA4Ward").innerHTML=""
      }
    }

    function sleep(milliseconds) {
      var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds){
              break;
            }
          }
    }
  </script>
</body>
</html>
